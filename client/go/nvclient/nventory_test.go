// Copyright Â© 2016 Andrew Cheung <ac1493@yp.com>
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package nvclient

import (
	"fmt"
	"io/ioutil"
	"strings"
	"testing"

	"bufio"
	"net/http"
	"net/http/httptest"

	"os"

	logger "github.com/atclate/go-logger"
	"github.com/stretchr/testify/assert"
	"github.com/urfave/cli"
)

var (
	requests  = make([]*http.Request, 0)
	responses map[resp_key]*httptest.ResponseRecorder
)

type resp_key struct{ m, p string }

type TSC struct {
	input TSCI
	exp   []string
	resp  []RSC
}
type TSCI struct {
	searchCommand *SearchCommands
	args          cli.Args
	userInput     string
}
type TSC2 struct {
	input TSCI2
	exp   []string
	resp  []RSC
}
type TSCI2 struct {
	searchCommand *SetCommands
	args          cli.Args
	userInput     string
}

func TestCookies(t *testing.T) {
	logger.InitLogger(ioutil.Discard, os.Stdout, os.Stdout, os.Stderr, ioutil.Discard)


	initResponses()
	tp := NewTestServer()

	driver := NewNventoryDriver(bufio.NewReader(os.Stdin))
	driver.SetServer(tp.URL)
	//driver.SetServer("http://opsdb")
	httpClient := driver.GetHttpClientFor(autoreg)
	assert.NotNil(t, httpClient, "http.Client hould not be nil")
}

func TestSearchNodesInNventory(t *testing.T) {
	logger.InitLogger(ioutil.Discard, os.Stdout, os.Stdout, os.Stderr, ioutil.Discard)
	driver := NewNventoryDriver(bufio.NewReader(os.Stdin))
	driver.SetServer("http://opsdb.wc1.example.com")

	tcs := []TSC{
		// No search result positive case.
		{
			TSCI{
				&SearchCommands{searchFlags: &SearchFlags{Get: []string{"hardware_profile[name]=abc-doesnt-exist"}}, objectType: "nodes"},
				[]string{},
				"",
			},
			[]string{"No matching objects"},
			[]RSC{
				{key: resp_key{m: "GET", p: "/nodes.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?><nil_classes type="array"/>`},
			},
		},
		// Lookup a host by serial number.
		{
			TSCI{
				&SearchCommands{searchFlags: &SearchFlags{Get: []string{"virtual_host[serial_number]=MXQ44802PL"}}, objectType: "nodes"},
				[]string{},
				"",
			},
			[]string{"opsdb3.wc1.example.com"},
			[]RSC{
				{key: resp_key{m: "GET", p: "/nodes.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?><nodes type="array"><node><asset_tag nil="true"></asset_tag><avail_space type="integer">489851180</avail_space><cage nil="true"></cage><config_mgmt_tag nil="true"></config_mgmt_tag><console_type nil="true"></console_type><contact nil="true"></contact><created_at type="datetime">2015-07-13T18:13:31+00:00</created_at><description nil="true"></description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">280</hardware_profile_id><id type="integer">42060</id><kernel_version>2.6.32-504.8.1.el6.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>opsdb3.wc1.example.com</name><operating_system_id type="integer">251</operating_system_id><os_memory>32068</os_memory><os_processor_count type="integer">2</os_processor_count><os_virtual_processor_count type="integer">40</os_virtual_processor_count><physical_memory>32768</physical_memory><physical_memory_sizes>8x4096</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">20</processor_core_count><processor_count type="integer">2</processor_count><processor_manufacturer>Intel</processor_manufacturer><processor_model>Xeon</processor_model><processor_socket_count type="integer">2</processor_socket_count><processor_speed>1700 MHz</processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number>MXQ44802PL      </serial_number><status_id type="integer">1</status_id><swap>2046</swap><timezone>UTC</timezone><uniqueid>31353337-3135-584D-5134-34383032504C</uniqueid><updated_at type="datetime">2016-06-14T20:24:09+00:00</updated_at><used_space type="integer">55446148</used_space><virtualarch nil="true"></virtualarch><vmimg_size type="integer" nil="true"></vmimg_size><vmspace_used type="integer" nil="true"></vmspace_used><virtual_assignments_as_host type="array"/></node></nodes>`},
			},
		},
		// Search by os with quote
		{
			TSCI{
				&SearchCommands{searchFlags: &SearchFlags{Get: []string{"os=Red Hat CentOS Linux 6.6 x86_64"}}, objectType: "nodes"},
				[]string{},
				"",
			},
			[]string{"opsdb3.wc1.example.com"},
			[]RSC{
				{key: resp_key{m: "GET", p: "/nodes.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?><nodes type="array"><node><asset_tag nil="true"></asset_tag><avail_space type="integer">489851180</avail_space><cage nil="true"></cage><config_mgmt_tag nil="true"></config_mgmt_tag><console_type nil="true"></console_type><contact nil="true"></contact><created_at type="datetime">2015-07-13T18:13:31+00:00</created_at><description nil="true"></description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">280</hardware_profile_id><id type="integer">42060</id><kernel_version>2.6.32-504.8.1.el6.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>opsdb3.wc1.example.com</name><operating_system_id type="integer">251</operating_system_id><os_memory>32068</os_memory><os_processor_count type="integer">2</os_processor_count><os_virtual_processor_count type="integer">40</os_virtual_processor_count><physical_memory>32768</physical_memory><physical_memory_sizes>8x4096</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">20</processor_core_count><processor_count type="integer">2</processor_count><processor_manufacturer>Intel</processor_manufacturer><processor_model>Xeon</processor_model><processor_socket_count type="integer">2</processor_socket_count><processor_speed>1700 MHz</processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number>MXQ44802PL      </serial_number><status_id type="integer">1</status_id><swap>2046</swap><timezone>UTC</timezone><uniqueid>31353337-3135-584D-5134-34383032504C</uniqueid><updated_at type="datetime">2016-06-14T20:24:09+00:00</updated_at><used_space type="integer">55446148</used_space><virtualarch nil="true"></virtualarch><vmimg_size type="integer" nil="true"></vmimg_size><vmspace_used type="integer" nil="true"></vmspace_used></node></nodes>`},
			},
		},
		// --get name=dev-email2lwes.np.wc1 --fields virtual_host[name]
		{
			TSCI{
				&SearchCommands{searchFlags: &SearchFlags{Name: []string{"dev-email2lwes.np.wc1"}, Fields: []string{"virtual_host[name]"}}, objectType: "nodes"},
				[]string{"virtual_host[name]"},
				"",
			},
			[]string{"dev-email2lwes.np.wc1.example.com:", "virtual_host[name]: npvm197.np.wc1.example.com"},
			[]RSC{
				{key: resp_key{m: "GET", p: "/nodes.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?><nodes type="array"><node><asset_tag></asset_tag><avail_space type="integer">13019532</avail_space><cage nil="true"></cage><config_mgmt_tag></config_mgmt_tag><console_type></console_type><contact>rb4066,tdombrowski,hm143f,ac1493,msaltman</contact><created_at type="datetime">2015-12-04T01:20:44+00:00</created_at><description>===BEGIN REQUEST INFO===hostname: dev-email2lwes.np.wc1.example.comphysical_memory: 2048disk: 20processor_count: 1os: Red Hat CentOS Linux 6.5 x86_64contact: rb4066Node groups: vm-instance, wc1, dev===END REQUEST INFO===</description><expiration type="datetime">2018-01-04T01:20:00+00:00</expiration><hardware_profile_id type="integer">240</hardware_profile_id><id type="integer">44824</id><kernel_version>2.6.32-431.3.1.el6.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>dev-email2lwes.np.wc1.example.com</name><operating_system_id type="integer">230</operating_system_id><os_memory>1877</os_memory><os_processor_count type="integer" nil="true"></os_processor_count><os_virtual_processor_count type="integer">1</os_virtual_processor_count><physical_memory>2048</physical_memory><physical_memory_sizes>1x2048</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer" nil="true"></processor_core_count><processor_count type="integer">1</processor_count><processor_manufacturer>Bochs</processor_manufacturer><processor_model>Other</processor_model><processor_socket_count type="integer">1</processor_socket_count><processor_speed>2000 MHz</processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number>00:16:3E:5B:1E:71</serial_number><status_id type="integer">26</status_id><swap>1023</swap><timezone>UTC</timezone><uniqueid>BB586A65-84DA-5EFE-59CF-03F62C9A4471</uniqueid><updated_at type="datetime">2016-06-14T20:43:25+00:00</updated_at><used_space type="integer">5449784</used_space><virtualarch>kvm</virtualarch><vmimg_size type="integer">20971520</vmimg_size><vmspace_used type="integer">7530752</vmspace_used><virtual_host><asset_tag nil="true"></asset_tag><avail_space type="integer">263284624</avail_space><cage nil="true"></cage><config_mgmt_tag nil="true"></config_mgmt_tag><console_type nil="true"></console_type><contact nil="true"></contact><created_at type="datetime">2014-05-27T23:46:22+00:00</created_at><description nil="true"></description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">280</hardware_profile_id><id type="integer">34552</id><kernel_version>2.6.32-431.3.1.el6.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>npvm197.np.wc1.example.com</name><operating_system_id type="integer">230</operating_system_id><os_memory>64386</os_memory><os_processor_count type="integer">2</os_processor_count><os_virtual_processor_count type="integer">40</os_virtual_processor_count><physical_memory>65536</physical_memory><physical_memory_sizes>8x8192</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">20</processor_core_count><processor_count type="integer">2</processor_count><processor_manufacturer>Intel</processor_manufacturer><processor_model>Xeon</processor_model><processor_socket_count type="integer">2</processor_socket_count><processor_speed>1700 MHz</processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number>MXQ41700MP      </serial_number><status_id type="integer">1</status_id><swap>2046</swap><timezone>UTC</timezone><uniqueid>31353337-3135-584D-5134-313730304D50</uniqueid><updated_at type="datetime">2016-06-14T20:46:44+00:00</updated_at><used_space type="integer">282143776</used_space><virtualarch>kvm</virtualarch><vmimg_size type="integer" nil="true"></vmimg_size><vmspace_used type="integer" nil="true"></vmspace_used></virtual_host></node></nodes>`},
			},
		},
		// --name opsdb3 --fields node_groups
		{
			TSCI{
				&SearchCommands{searchFlags: &SearchFlags{Name: []string{"opsdb3"}, Fields: []string{"node_groups"}}, objectType: "nodes"},
				[]string{"node_groups"},
				"",
			},
			[]string{"opsdb3.wc1.example.com:", "node_groups[name]: opsdb"},
			[]RSC{
				{key: resp_key{m: "GET", p: "/nodes.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?><nodes type="array"><node><asset_tag nil="true"></asset_tag><avail_space type="integer">513794560</avail_space><cage>AC6</cage><config_mgmt_tag nil="true"></config_mgmt_tag><console_type nil="true"></console_type><contact nil="true"></contact><created_at type="datetime">2015-07-13T19:10:44+00:00</created_at><description nil="true"></description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">280</hardware_profile_id><id type="integer">42065</id><kernel_version>2.6.32-504.8.1.el6.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>opsdb3.ev1.example.com</name><operating_system_id type="integer">251</operating_system_id><os_memory>32068</os_memory><os_processor_count type="integer">2</os_processor_count><os_virtual_processor_count type="integer">40</os_virtual_processor_count><physical_memory>32768</physical_memory><physical_memory_sizes>8x4096</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">20</processor_core_count><processor_count type="integer">2</processor_count><processor_manufacturer>Intel</processor_manufacturer><processor_model>Xeon</processor_model><processor_socket_count type="integer">2</processor_socket_count><processor_speed>1700 MHz</processor_speed><rack_num>12</rack_num><rack_row>1</rack_row><rack_unit>31</rack_unit><serial_number>MXQ44804F0      </serial_number><status_id type="integer">1</status_id><swap>2046</swap><timezone>UTC</timezone><uniqueid>31353337-3135-584D-5134-343830344630</uniqueid><updated_at type="datetime">2016-06-14T21:43:06+00:00</updated_at><used_space type="integer">31502768</used_space><virtualarch nil="true"></virtualarch><vmimg_size type="integer" nil="true"></vmimg_size><vmspace_used type="integer" nil="true"></vmspace_used><node_groups type="array"><node_group><created_at type="datetime">2008-07-08T11:18:15+00:00</created_at><description></description><id type="integer">10</id><name>opsdb-db-master_prod</name><owner></owner><updated_at type="datetime">2009-03-30T15:43:31+00:00</updated_at></node_group><node_group><created_at type="datetime">2008-07-08T11:21:57+00:00</created_at><description></description><id type="integer">12</id><name>opsdb-app_prod</name><owner></owner><updated_at type="datetime">2009-03-30T15:43:47+00:00</updated_at></node_group><node_group><created_at type="datetime">2008-07-08T11:22:24+00:00</created_at><description></description><id type="integer">13</id><name>opsdb-web_prod</name><owner></owner><updated_at type="datetime">2009-03-30T15:42:57+00:00</updated_at></node_group><node_group><created_at type="datetime">2008-08-13T16:25:31+00:00</created_at><description></description><id type="integer">23</id><name>opsdb_prod</name><owner></owner><updated_at type="datetime">2009-03-30T15:42:41+00:00</updated_at></node_group><node_group><created_at type="datetime">2009-02-12T10:52:09+00:00</created_at><description></description><id type="integer">174</id><name>opsdb-db_prod</name><owner></owner><updated_at type="datetime">2009-03-30T15:43:04+00:00</updated_at></node_group><node_group><created_at type="datetime">2009-03-11T11:11:35+00:00</created_at><description>NCA Production Servers</description><id type="integer">296</id><name>prod</name><owner>windowsinfrastructure@yp.com</owner><updated_at type="datetime">2014-04-28T21:52:11+00:00</updated_at></node_group><node_group><created_at type="datetime">2009-05-13T18:15:49+00:00</created_at><description>All OpsDB servers</description><id type="integer">512</id><name>opsdb</name><owner>appsupport@yp.com</owner><updated_at type="datetime">2012-11-30T19:51:52+00:00</updated_at></node_group><node_group><created_at type="datetime">2010-12-06T23:03:21+00:00</created_at><description></description><id type="integer">2218</id><name>ev1</name><owner></owner><updated_at type="datetime">2010-12-06T23:03:21+00:00</updated_at></node_group><node_group><created_at type="datetime">2015-10-27T20:38:01+00:00</created_at><description></description><id type="integer">7508</id><name>technology_operations</name><owner>atiplitsky@yp.com</owner><updated_at type="datetime">2015-11-11T22:07:45+00:00</updated_at></node_group><node_group><created_at type="datetime">2015-12-03T23:40:52+00:00</created_at><description>Nodes owned/managed by the POT team.</description><id type="integer">7632</id><name>pot</name><owner>prodopstools@yp.com</owner><updated_at type="datetime">2015-12-03T23:40:52+00:00</updated_at></node_group><node_group><created_at type="datetime">2016-06-14T19:45:39+00:00</created_at><description>locally hosted instance of nVentory open source application - production system at http://opsdb.int.yp.com</description><id type="integer">8237</id><name>opsdb-server</name><owner>prodopstools@yp.com</owner><updated_at type="datetime">2016-06-14T19:45:39+00:00</updated_at></node_group></node_groups></node><node><asset_tag nil="true"></asset_tag><avail_space type="integer">489607324</avail_space><cage nil="true"></cage><config_mgmt_tag nil="true"></config_mgmt_tag><console_type nil="true"></console_type><contact nil="true"></contact><created_at type="datetime">2015-07-13T18:13:31+00:00</created_at><description nil="true"></description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">280</hardware_profile_id><id type="integer">42060</id><kernel_version>2.6.32-504.8.1.el6.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>opsdb3.wc1.example.com</name><operating_system_id type="integer">251</operating_system_id><os_memory>32068</os_memory><os_processor_count type="integer">2</os_processor_count><os_virtual_processor_count type="integer">40</os_virtual_processor_count><physical_memory>32768</physical_memory><physical_memory_sizes>8x4096</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">20</processor_core_count><processor_count type="integer">2</processor_count><processor_manufacturer>Intel</processor_manufacturer><processor_model>Xeon</processor_model><processor_socket_count type="integer">2</processor_socket_count><processor_speed>1700 MHz</processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number>MXQ44802PL      </serial_number><status_id type="integer">1</status_id><swap>2046</swap><timezone>UTC</timezone><uniqueid>31353337-3135-584D-5134-34383032504C</uniqueid><updated_at type="datetime">2016-06-14T23:24:10+00:00</updated_at><used_space type="integer">55690004</used_space><virtualarch nil="true"></virtualarch><vmimg_size type="integer" nil="true"></vmimg_size><vmspace_used type="integer" nil="true"></vmspace_used><node_groups type="array"><node_group><created_at type="datetime">2008-07-08T11:18:15+00:00</created_at><description></description><id type="integer">10</id><name>opsdb-db-master_prod</name><owner></owner><updated_at type="datetime">2009-03-30T15:43:31+00:00</updated_at></node_group><node_group><created_at type="datetime">2008-07-08T11:21:57+00:00</created_at><description></description><id type="integer">12</id><name>opsdb-app_prod</name><owner></owner><updated_at type="datetime">2009-03-30T15:43:47+00:00</updated_at></node_group><node_group><created_at type="datetime">2008-07-08T11:22:24+00:00</created_at><description></description><id type="integer">13</id><name>opsdb-web_prod</name><owner></owner><updated_at type="datetime">2009-03-30T15:42:57+00:00</updated_at></node_group><node_group><created_at type="datetime">2008-08-13T16:25:31+00:00</created_at><description></description><id type="integer">23</id><name>opsdb_prod</name><owner></owner><updated_at type="datetime">2009-03-30T15:42:41+00:00</updated_at></node_group><node_group><created_at type="datetime">2009-02-12T10:52:09+00:00</created_at><description></description><id type="integer">174</id><name>opsdb-db_prod</name><owner></owner><updated_at type="datetime">2009-03-30T15:43:04+00:00</updated_at></node_group><node_group><created_at type="datetime">2009-03-11T11:11:35+00:00</created_at><description>NCA Production Servers</description><id type="integer">296</id><name>prod</name><owner>windowsinfrastructure@yp.com</owner><updated_at type="datetime">2014-04-28T21:52:11+00:00</updated_at></node_group><node_group><created_at type="datetime">2009-05-13T18:15:49+00:00</created_at><description>All OpsDB servers</description><id type="integer">512</id><name>opsdb</name><owner>appsupport@yp.com</owner><updated_at type="datetime">2012-11-30T19:51:52+00:00</updated_at></node_group><node_group><created_at type="datetime">2010-12-06T23:02:57+00:00</created_at><description></description><id type="integer">2216</id><name>wc1</name><owner></owner><updated_at type="datetime">2010-12-06T23:02:57+00:00</updated_at></node_group><node_group><created_at type="datetime">2015-10-27T20:38:01+00:00</created_at><description></description><id type="integer">7508</id><name>technology_operations</name><owner>atiplitsky@yp.com</owner><updated_at type="datetime">2015-11-11T22:07:45+00:00</updated_at></node_group><node_group><created_at type="datetime">2015-12-03T23:40:52+00:00</created_at><description>Nodes owned/managed by the POT team.</description><id type="integer">7632</id><name>pot</name><owner>prodopstools@yp.com</owner><updated_at type="datetime">2015-12-03T23:40:52+00:00</updated_at></node_group><node_group><created_at type="datetime">2016-06-14T19:45:39+00:00</created_at><description>locally hosted instance of nVentory open source application - production system at http://opsdb.int.yp.com</description><id type="integer">8237</id><name>opsdb-server</name><owner>prodopstools@yp.com</owner><updated_at type="datetime">2016-06-14T19:45:39+00:00</updated_at></node_group></node_groups></node></nodes>`},
			},
		},
		// --name npvm2.np.wc1.example.com --fields=virtual_guests[name]
		{
			TSCI{
				&SearchCommands{searchFlags: &SearchFlags{Name: []string{"npvm2.np.wc1.example.com"}, Fields: []string{"virtual_guests[name]"}}, objectType: "nodes"},
				[]string{"virtual_guests[name]"},
				"",
			},
			[]string{"npvm2.np.wc1.example.com:", "virtual_guests[name]: cpl.np.wc1.example.com"},
			[]RSC{
				{key: resp_key{m: "GET", p: "/nodes.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?><nodes type="array"><node><asset_tag></asset_tag><avail_space type="integer">180449700</avail_space><cage></cage><config_mgmt_tag>trunk-20140521-1800</config_mgmt_tag><console_type></console_type><contact></contact><created_at type="datetime">2009-05-07T15:45:29+00:00</created_at><description></description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">120</hardware_profile_id><id type="integer">2518</id><kernel_version>2.6.18-308.8.2.el5xen</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>npvm2.np.wc1.example.com</name><operating_system_id type="integer">194</operating_system_id><os_memory>5941</os_memory><os_processor_count type="integer">8</os_processor_count><os_virtual_processor_count type="integer">8</os_virtual_processor_count><physical_memory>16384</physical_memory><physical_memory_sizes>4x4096</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">8</processor_core_count><processor_count type="integer">2</processor_count><processor_manufacturer>Intel</processor_manufacturer><processor_model>Xeon</processor_model><processor_socket_count type="integer">2</processor_socket_count><processor_speed>2500 MHz</processor_speed><rack_num></rack_num><rack_row></rack_row><rack_unit></rack_unit><serial_number>USE914L70F      </serial_number><status_id type="integer">26</status_id><swap>2047</swap><timezone>UTC</timezone><uniqueid>35303137-3135-5553-4539-31344C373046</uniqueid><updated_at type="datetime">2016-06-14T22:48:10+00:00</updated_at><used_space type="integer">86733372</used_space><virtualarch>xen</virtualarch><vmimg_size type="integer" nil="true"></vmimg_size><vmspace_used type="integer" nil="true"></vmspace_used><virtual_guests type="array"><virtual_guest type="Node"><asset_tag nil="true"></asset_tag><avail_space type="integer">29596664</avail_space><cage nil="true"></cage><config_mgmt_tag nil="true"></config_mgmt_tag><console_type nil="true"></console_type><contact>bhenderson,aavilla</contact><created_at type="datetime">2010-01-21T17:29:08+00:00</created_at><description>==============BEGIN REQUEST INFO==============hostname: paste.np.wc1.example.comphysical_memory: 2048disk: 35processor_count: 1IP Address: _IP_ADDRESS_contact: ehodelNode groups: vm-instance, dev===============END REQUEST INFO===============</description><expiration type="datetime">2016-12-22T16:29:07+00:00</expiration><hardware_profile_id type="integer">132</hardware_profile_id><id type="integer">5610</id><kernel_version>2.6.18-164.11.1.el5xen</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>paste.np.wc1.example.com</name><operating_system_id type="integer">98</operating_system_id><os_memory>2048</os_memory><os_processor_count type="integer">1</os_processor_count><os_virtual_processor_count type="integer">1</os_virtual_processor_count><physical_memory>2048</physical_memory><physical_memory_sizes nil="true"></physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">1</processor_core_count><processor_count type="integer" nil="true"></processor_count><processor_manufacturer></processor_manufacturer><processor_model></processor_model><processor_socket_count type="integer">1</processor_socket_count><processor_speed></processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number></serial_number><status_id type="integer">26</status_id><swap>1027</swap><timezone>UTC</timezone><uniqueid>00:16:3E:62:B6:26</uniqueid><updated_at type="datetime">2016-06-14T22:48:09+00:00</updated_at><used_space type="integer">3152648</used_space><virtualarch>xen</virtualarch><vmimg_size type="integer">36701184</vmimg_size><vmspace_used type="integer">8553892</vmspace_used></virtual_guest><virtual_guest type="Node"><asset_tag nil="true"></asset_tag><avail_space type="integer">13253804</avail_space><cage nil="true"></cage><config_mgmt_tag nil="true"></config_mgmt_tag><console_type nil="true"></console_type><contact>ctong</contact><created_at type="datetime">2010-08-30T18:47:56+00:00</created_at><description>==============BEGIN REQUEST INFO==============hostname: ctongvm.np.wc1.example.comos: Red Hat CentOS Linux 5.4 x86_64physical_memory: 2048disk: 35processor_count: 1contact: ctongNode groups: vm-instance, dev===============END REQUEST INFO===============</description><expiration type="datetime">2017-09-30T18:47:55+00:00</expiration><hardware_profile_id type="integer">132</hardware_profile_id><id type="integer">10006</id><kernel_version>2.6.18-164.11.1.el5xen</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>ctongvm.np.wc1.example.com</name><operating_system_id type="integer">98</operating_system_id><os_memory>2048</os_memory><os_processor_count type="integer">1</os_processor_count><os_virtual_processor_count type="integer">1</os_virtual_processor_count><physical_memory>2048</physical_memory><physical_memory_sizes nil="true"></physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">1</processor_core_count><processor_count type="integer" nil="true"></processor_count><processor_manufacturer></processor_manufacturer><processor_model></processor_model><processor_socket_count type="integer">1</processor_socket_count><processor_speed></processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number></serial_number><status_id type="integer">26</status_id><swap>1027</swap><timezone>UTC</timezone><uniqueid>00:16:3E:C0:83:62</uniqueid><updated_at type="datetime">2016-06-14T22:10:03+00:00</updated_at><used_space type="integer">19347028</used_space><virtualarch>xen</virtualarch><vmimg_size type="integer">36700160</vmimg_size><vmspace_used type="integer">36174856</vmspace_used></virtual_guest><virtual_guest type="Node"><asset_tag nil="true"></asset_tag><avail_space type="integer">5262744</avail_space><cage nil="true"></cage><config_mgmt_tag nil="true"></config_mgmt_tag><console_type nil="true"></console_type><contact>pwu,dcheung,akohli,dhang</contact><created_at type="datetime">2013-01-15T22:13:51+00:00</created_at><description>===BEGIN REQUEST INFO===hostname: cpl.np.wc1.example.comphysical_memory: 2048disk: 35processor_count: 1os: Red Hat CentOS Linux 5.8 x86_64contact: pwuNode groups: vm-instance, dev===END REQUEST INFO===</description><expiration type="datetime">2016-08-15T22:13:50+00:00</expiration><hardware_profile_id type="integer">132</hardware_profile_id><id type="integer">25366</id><kernel_version>2.6.18-308.8.2.el5xen</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>cpl.np.wc1.example.com</name><operating_system_id type="integer">194</operating_system_id><os_memory>2048</os_memory><os_processor_count type="integer">1</os_processor_count><os_virtual_processor_count type="integer">1</os_virtual_processor_count><physical_memory>2048</physical_memory><physical_memory_sizes nil="true"></physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">1</processor_core_count><processor_count type="integer" nil="true"></processor_count><processor_manufacturer></processor_manufacturer><processor_model></processor_model><processor_socket_count type="integer">1</processor_socket_count><processor_speed></processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number></serial_number><status_id type="integer">26</status_id><swap>1027</swap><timezone>UTC</timezone><uniqueid>00:16:3E:2A:AD:C6</uniqueid><updated_at type="datetime">2016-06-14T22:30:05+00:00</updated_at><used_space type="integer">27338088</used_space><virtualarch>xen</virtualarch><vmimg_size type="integer">36700159</vmimg_size><vmspace_used type="integer">32701316</vmspace_used></virtual_guest><virtual_guest type="Node"><asset_tag></asset_tag><avail_space type="integer">30142928</avail_space><cage nil="true"></cage><config_mgmt_tag></config_mgmt_tag><console_type></console_type><contact>rbeltran,ksugana,pkhin, mkhare</contact><created_at type="datetime">2013-04-15T17:55:39+00:00</created_at><description>===BEGIN REQUEST INFO===hostname: searchdevdb1.np.wc1.example.comphysical_memory: 2048disk: 35processor_count: 1os: Red Hat CentOS Linux 5.8 x86_64contact: pmani,rbeltran,ksugana,pkhin, mkhare, sreddyNode groups: vm-instance, dev, search, search_dev===END REQUEST INFO===</description><expiration type="datetime">2016-12-15T17:55:00+00:00</expiration><hardware_profile_id type="integer">132</hardware_profile_id><id type="integer">26912</id><kernel_version>2.6.18-308.8.2.el5xen</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>searchdevdb1.np.wc1.example.com</name><operating_system_id type="integer">194</operating_system_id><os_memory>2048</os_memory><os_processor_count type="integer">1</os_processor_count><os_virtual_processor_count type="integer">1</os_virtual_processor_count><physical_memory>2048</physical_memory><physical_memory_sizes></physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">1</processor_core_count><processor_count type="integer" nil="true"></processor_count><processor_manufacturer></processor_manufacturer><processor_model></processor_model><processor_socket_count type="integer">1</processor_socket_count><processor_speed></processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number></serial_number><status_id type="integer">26</status_id><swap>1027</swap><timezone>UTC</timezone><uniqueid>00:16:3E:B7:E3:58</uniqueid><updated_at type="datetime">2016-06-14T21:15:57+00:00</updated_at><used_space type="integer">2457904</used_space><virtualarch>xen</virtualarch><vmimg_size type="integer">36700159</vmimg_size><vmspace_used type="integer">4155368</vmspace_used></virtual_guest></virtual_guests></node></nodes>`},
			},
		},
		// --get mac=18:a9:05:46:ba:ee --fields name
		{
			TSCI{
				&SearchCommands{searchFlags: &SearchFlags{Get: []string{"mac=18:a9:05:46:ba:ee"}, Fields: []string{"name"}}, objectType: "nodes"},
				[]string{"name"},
				"",
			},
			[]string{"dfm.wc1.example.com:", "name: dfm.wc1.example.com", "network_interfaces[name]: eth1"},
			[]RSC{
				{key: resp_key{m: "GET", p: "/nodes.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?><nodes type="array"><node><asset_tag></asset_tag><avail_space type="integer">564136048</avail_space><cage>OC1</cage><config_mgmt_tag></config_mgmt_tag><console_type></console_type><contact>fma,steveyang,cthomasian,jn0589</contact><created_at type="datetime">2009-11-23T13:59:31+00:00</created_at><description></description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">134</hardware_profile_id><id type="integer">4352</id><kernel_version>2.6.32-573.el6.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>dfm.wc1.example.com</name><operating_system_id type="integer">366</operating_system_id><os_memory>15935</os_memory><os_processor_count type="integer">2</os_processor_count><os_virtual_processor_count type="integer">16</os_virtual_processor_count><physical_memory>16384</physical_memory><physical_memory_sizes>4x4096</physical_memory_sizes><power_supply_count type="integer">2</power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">8</processor_core_count><processor_count type="integer">2</processor_count><processor_manufacturer>Intel</processor_manufacturer><processor_model>Xeon</processor_model><processor_socket_count type="integer">2</processor_socket_count><processor_speed>2267 MHz</processor_speed><rack_num>17</rack_num><rack_row>2</rack_row><rack_unit>32</rack_unit><serial_number>USE946N6KJ      </serial_number><status_id type="integer">1</status_id><swap>2046</swap><timezone>UTC</timezone><uniqueid>31343834-3438-5355-4539-34364E364B4A</uniqueid><updated_at type="datetime">2016-06-14T23:05:25+00:00</updated_at><used_space type="integer">254706724</used_space><virtualarch></virtualarch><vmimg_size type="integer" nil="true"></vmimg_size><vmspace_used type="integer" nil="true"></vmspace_used><network_interfaces type="array"><network_interface><autonegotiate type="boolean">true</autonegotiate><created_at type="datetime">2009-11-23T13:59:31+00:00</created_at><full_duplex type="boolean">true</full_duplex><hardware_address>18:A9:05:46:BA:EE</hardware_address><id type="integer">14842</id><interface_type>Ethernet</interface_type><link type="boolean">true</link><name>eth1</name><node_id type="integer">4352</node_id><physical type="boolean">true</physical><speed type="integer">1000</speed><up type="boolean">true</up><updated_at type="datetime">2014-08-14T02:05:54+00:00</updated_at></network_interface></network_interfaces></node></nodes>`},
			},
		},
		// --get name=prodvm --get node_groups[name]=xen
		{
			TSCI{
				&SearchCommands{searchFlags: &SearchFlags{Get: []string{"name=prodvm", "node_groups[name]=xen"}}, objectType: "nodes"},
				[]string{},
				"",
			},
			[]string{"prodvm1.prod.ev1.example.com", "prodvm56.prod.wc1.example.com"},
			[]RSC{
				{key: resp_key{m: "GET", p: "/nodes.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?><nodes type="array"><node><asset_tag></asset_tag><avail_space type="integer">1089243184</avail_space><cage>AC4</cage><config_mgmt_tag></config_mgmt_tag><console_type></console_type><contact></contact><created_at type="datetime">2009-10-14T18:55:07+00:00</created_at><description></description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">134</hardware_profile_id><id type="integer">3655</id><kernel_version>2.6.32-573.1.1.el6.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>prodvm1.prod.ev1.example.com</name><operating_system_id type="integer">365</operating_system_id><os_memory>15937</os_memory><os_processor_count type="integer">2</os_processor_count><os_virtual_processor_count type="integer">16</os_virtual_processor_count><physical_memory>16384</physical_memory><physical_memory_sizes>4x4096</physical_memory_sizes><power_supply_count type="integer">2</power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">8</processor_core_count><processor_count type="integer">2</processor_count><processor_manufacturer>Intel</processor_manufacturer><processor_model>Quad-Core Xeon</processor_model><processor_socket_count type="integer">2</processor_socket_count><processor_speed>2267 MHz</processor_speed><rack_num>1</rack_num><rack_row>1</rack_row><rack_unit>28</rack_unit><serial_number>9Q99MP7539      </serial_number><status_id type="integer">1</status_id><swap>2047</swap><timezone>UTC</timezone><uniqueid>34333231-3535-5139-3939-4D5037353339</uniqueid><updated_at type="datetime">2016-06-14T22:45:25+00:00</updated_at><used_space type="integer">3292032</used_space><virtualarch>kvm</virtualarch><vmimg_size type="integer" nil="true"></vmimg_size><vmspace_used type="integer" nil="true"></vmspace_used><node_group_node_assignments type="array"><node_group_node_assignment><assigned_at type="datetime">2011-01-13T02:14:07+00:00</assigned_at><created_at type="datetime">2011-01-13T02:14:07+00:00</created_at><id type="integer">89215</id><node_group_id type="integer">244</node_group_id><node_id type="integer">3655</node_id><updated_at type="datetime">2011-01-13T02:14:07+00:00</updated_at><virtual_assignment type="boolean" nil="true"></virtual_assignment><node_group><created_at type="datetime">2009-02-19T18:43:51+00:00</created_at><description>YPC and the art of Xen? overused?</description><id type="integer">244</id><name>xen</name><owner>unixsysadmins@yp.com</owner><updated_at type="datetime">2014-05-09T17:46:32+00:00</updated_at></node_group></node_group_node_assignment></node_group_node_assignments></node><node><asset_tag nil="true"></asset_tag><avail_space type="integer">351774004</avail_space><cage nil="true"></cage><config_mgmt_tag>trunk-20140521-1800</config_mgmt_tag><console_type nil="true"></console_type><contact nil="true"></contact><created_at type="datetime">2011-05-25T23:42:40+00:00</created_at><description nil="true"></description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">232</hardware_profile_id><id type="integer">15270</id><kernel_version>2.6.18-194.3.1.el5xen</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>prodvm56.prod.wc1.example.com</name><operating_system_id type="integer">114</operating_system_id><os_memory>6579</os_memory><os_processor_count type="integer">24</os_processor_count><os_virtual_processor_count type="integer">24</os_virtual_processor_count><physical_memory>49152</physical_memory><physical_memory_sizes>6x8192</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">24</processor_core_count><processor_count type="integer">2</processor_count><processor_manufacturer>Intel</processor_manufacturer><processor_model>Xeon</processor_model><processor_socket_count type="integer">2</processor_socket_count><processor_speed>2267 MHz</processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number>USE1169BC7      </serial_number><status_id type="integer">1</status_id><swap>2047</swap><timezone>UTC</timezone><uniqueid>37333036-3831-5355-4531-313639424337</uniqueid><updated_at type="datetime">2016-06-14T21:13:59+00:00</updated_at><used_space type="integer">184533288</used_space><virtualarch>xen</virtualarch><vmimg_size type="integer" nil="true"></vmimg_size><vmspace_used type="integer" nil="true"></vmspace_used><node_group_node_assignments type="array"><node_group_node_assignment><assigned_at type="datetime">2011-05-27T01:39:23+00:00</assigned_at><created_at type="datetime">2011-05-27T01:39:23+00:00</created_at><id type="integer">104110</id><node_group_id type="integer">244</node_group_id><node_id type="integer">15270</node_id><updated_at type="datetime">2011-05-27T01:39:23+00:00</updated_at><virtual_assignment type="boolean" nil="true"></virtual_assignment><node_group><created_at type="datetime">2009-02-19T18:43:51+00:00</created_at><description>YPC and the art of Xen? overused?</description><id type="integer">244</id><name>xen</name><owner>unixsysadmins@yp.com</owner><updated_at type="datetime">2014-05-09T17:46:32+00:00</updated_at></node_group></node_group_node_assignment></node_group_node_assignments></node></nodes>`},
			},
		},
		// --name ceph --fields=name_aliases[name] --fields=name_aliases[id]
		{
			TSCI{
				&SearchCommands{searchFlags: &SearchFlags{Get: []string{"name=ceph"}, Fields: []string{"name_aliases[name]", "name_aliases[id]"}}, objectType: "nodes"},
				[]string{"name_aliases[name]", "name_aliases[id]"},
				"",
			},
			[]string{"ceph-dashboard.np.ev1.example.com:", "name_aliases[id]: 73919", "name_aliases[name]: ceph-dashboard"},
			[]RSC{
				{key: resp_key{m: "GET", p: "/nodes.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?><nodes type="array"><node><asset_tag></asset_tag><avail_space type="integer">98287980</avail_space><cage nil="true"></cage><config_mgmt_tag></config_mgmt_tag><console_type></console_type><contact>vv4435,mk7193,gnolan,ishaikh,jskaletsky,jg4843</contact><created_at type="datetime">2015-05-11T15:54:31+00:00</created_at><description>===BEGIN REQUEST INFO===hostname: ceph-dashboard.np.ev1.example.comJustifications: moving dashboard off of physical node due to frequent crashingphysical_memory: 2048disk: 105processor_count: 4os: Red Hat CentOS Linux 6.6 x86_64contact: mk7193Node groups: vm-instance, ev1===END REQUEST INFO===Jira Ticket:TWR-72318</description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">240</hardware_profile_id><id type="integer">40872</id><kernel_version>3.10.0-327.13.1.el7.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>ceph-dashboard.np.ev1.example.com</name><operating_system_id type="integer">380</operating_system_id><os_memory>1839</os_memory><os_processor_count type="integer">4</os_processor_count><os_virtual_processor_count type="integer">4</os_virtual_processor_count><physical_memory>2048</physical_memory><physical_memory_sizes>1x2048</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">4</processor_core_count><processor_count type="integer">4</processor_count><processor_manufacturer>Bochs</processor_manufacturer><processor_model>Other</processor_model><processor_socket_count type="integer">4</processor_socket_count><processor_speed>2000 MHz</processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number>00:16:3e:3f:e2:c7</serial_number><status_id type="integer">26</status_id><swap>1023</swap><timezone>US/Pacific-New</timezone><uniqueid>8B5826B6-0897-8DDE-689C-6522468480FC</uniqueid><updated_at type="datetime">2016-06-14T21:48:55+00:00</updated_at><used_space type="integer">3163740</used_space><virtualarch>kvm</virtualarch><vmimg_size type="integer">110100480</vmimg_size><vmspace_used type="integer">8047544</vmspace_used><name_aliases type="array"><name_alias><created_at type="datetime">2015-05-11T16:09:34+00:00</created_at><id type="integer">73919</id><name>ceph-dashboard</name><source_id type="integer">40872</source_id><source_type>Node</source_type><updated_at type="datetime">2015-05-11T16:09:34+00:00</updated_at></name_alias><name_alias><created_at type="datetime">2015-05-11T16:09:34+00:00</created_at><id type="integer">73917</id><name>ceph-dashboard.np.ev1.example.com</name><source_id type="integer">40872</source_id><source_type>Node</source_type><updated_at type="datetime">2015-05-11T16:09:34+00:00</updated_at></name_alias><name_alias><created_at type="datetime">2015-09-13T15:46:55+00:00</created_at><id type="integer">79905</id><name>localhost</name><source_id type="integer">40872</source_id><source_type>Node</source_type><updated_at type="datetime">2015-09-13T15:46:55+00:00</updated_at></name_alias></name_aliases></node></nodes>`},
			},
		},
		/*
			Set:
			nv --name ceph5.np.ev1.example.com --set avail_space=107520
			nv --exactget node=prod198.wc1.example.com --addtonodegroup sudo_jorgetapia
			nv --name npvm109.np.wc1.example.com --addtonodegroup ss-host_np,kvm
			nv --name gearman --set contact=mk7193,edavis,jskaletsky,jg4843
			nv --name cephvm[0-9] --set status=ss-test
			nv --name cephvm[0-9] --set expiration=2015-09-05T21:54:00+00:00
		*/
	}

	tp := NewTestServer()
	driver.SetServer(tp.URL)

	initResponses()

	for _, tc := range tcs {

		for _, resp := range tc.resp {
			r := httptest.NewRecorder()
			r.Header().Set("Content-Type", "application/xml")
			r.WriteHeader(resp.code)
			r.Write([]byte(resp.response))
			responses[resp.key] = r
		}

		act, err := SearchByCommand(driver, tc.input.searchCommand)

		assert.Nil(t, err, fmt.Sprintf("Error: %v", err))

		if err == nil {
			for _, e := range tc.exp {
				actual := PrintResultsFilterByFields(act, tc.input.args)
				assert.Equal(t, strings.Contains(actual, e), true, fmt.Sprintf("search %V\n(%#v expected,  %#v found)", tc.input.searchCommand, e, actual))
			}
		}
	}

}

func TestSetNodesInNventory(t *testing.T) {
	logger.InitLogger(ioutil.Discard, ioutil.Discard, ioutil.Discard, ioutil.Discard, ioutil.Discard)

	driver := NewNventoryDriver(bufio.NewReader(os.Stdin))

	tcs := []TSC2{
		// --name ceph5.np.ev1.example.com --set avail_space=107520
		{
			TSCI2{
				&SetCommands{searchCommand: &SearchCommands{searchFlags: &SearchFlags{Name: []string{"ceph5.np.ev1.example.com"}}, objectType: "nodes"}, setValueFlags: &SetValueFlags{[]string{"avail_space=16348828"}}},
				[]string{},
				"y\n",
			},
			[]string{"1 out of 1 update(s) succeeded."},
			[]RSC{
				{key: resp_key{m: "GET", p: "/nodes.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?><nodes type="array"><node><asset_tag nil="true"></asset_tag><avail_space type="integer">16348828</avail_space><cage nil="true"></cage><config_mgmt_tag nil="true"></config_mgmt_tag><console_type nil="true"></console_type><contact>mk7193</contact><created_at type="datetime">2016-06-13T19:31:13+00:00</created_at><description>===BEGIN REQUEST INFO===hostname: mk-ceph5.np.ev1.example.comphysical_memory: 1024disk: 20processor_count: 1os: Red Hat CentOS Linux 7.2 x86_64contact: mk7193Node groups: vm-instance, ev1===END REQUEST INFO===</description><expiration type="datetime">2016-07-13T19:31:12+00:00</expiration><hardware_profile_id type="integer">240</hardware_profile_id><id type="integer">53833</id><kernel_version>3.10.0-327.13.1.el7.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>mk-ceph5.np.ev1.example.com</name><operating_system_id type="integer">380</operating_system_id><os_memory>993</os_memory><os_processor_count type="integer">1</os_processor_count><os_virtual_processor_count type="integer">1</os_virtual_processor_count><physical_memory>1024</physical_memory><physical_memory_sizes>1x1024</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">1</processor_core_count><processor_count type="integer">1</processor_count><processor_manufacturer>Bochs</processor_manufacturer><processor_model>Other</processor_model><processor_socket_count type="integer">1</processor_socket_count><processor_speed>2000 MHz</processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number>00:16:3e:3b:56:12</serial_number><status_id type="integer">26</status_id><swap>1023</swap><timezone>UTC</timezone><uniqueid>0332E6EC-E38C-6FF2-42A2-76D1ABF55004</uniqueid><updated_at type="datetime">2016-06-14T22:29:47+00:00</updated_at><used_space type="integer">1829724</used_space><virtualarch>kvm</virtualarch><vmimg_size type="integer">20971520</vmimg_size><vmspace_used type="integer">2796652</vmspace_used></node></nodes>`},
				{key: resp_key{m: "PUT", p: "/nodes/53833.xml"}, code: 201, response: `<?xml version="1.0" encoding="UTF-8"?><nodes type="array"><node><asset_tag></asset_tag><avail_space type="integer">13019532</avail_space><cage nil="true"></cage><config_mgmt_tag></config_mgmt_tag><console_type></console_type><contact>rb4066,tdombrowski,hm143f,ac1493,msaltman</contact><created_at type="datetime">2015-12-04T01:20:44+00:00</created_at><description>===BEGIN REQUEST INFO===hostname: dev-email2lwes.np.wc1.example.comphysical_memory: 2048disk: 20processor_count: 1os: Red Hat CentOS Linux 6.5 x86_64contact: rb4066Node groups: vm-instance, wc1, dev===END REQUEST INFO===</description><expiration type="datetime">2018-01-04T01:20:00+00:00</expiration><hardware_profile_id type="integer">240</hardware_profile_id><id type="integer">44824</id><kernel_version>2.6.32-431.3.1.el6.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>dev-email2lwes.np.wc1.example.com</name><operating_system_id type="integer">230</operating_system_id><os_memory>1877</os_memory><os_processor_count type="integer" nil="true"></os_processor_count><os_virtual_processor_count type="integer">1</os_virtual_processor_count><physical_memory>2048</physical_memory><physical_memory_sizes>1x2048</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer" nil="true"></processor_core_count><processor_count type="integer">1</processor_count><processor_manufacturer>Bochs</processor_manufacturer><processor_model>Other</processor_model><processor_socket_count type="integer">1</processor_socket_count><processor_speed>2000 MHz</processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number>00:16:3E:5B:1E:71</serial_number><status_id type="integer">26</status_id><swap>1023</swap><timezone>UTC</timezone><uniqueid>BB586A65-84DA-5EFE-59CF-03F62C9A4471</uniqueid><updated_at type="datetime">2016-06-14T20:43:25+00:00</updated_at><used_space type="integer">5449784</used_space><virtualarch>kvm</virtualarch><vmimg_size type="integer">20971520</vmimg_size><vmspace_used type="integer">7530752</vmspace_used><virtual_host><asset_tag nil="true"></asset_tag><avail_space type="integer">263284624</avail_space><cage nil="true"></cage><config_mgmt_tag nil="true"></config_mgmt_tag><console_type nil="true"></console_type><contact nil="true"></contact><created_at type="datetime">2014-05-27T23:46:22+00:00</created_at><description nil="true"></description><expiration type="datetime" nil="true"></expiration><hardware_profile_id type="integer">280</hardware_profile_id><id type="integer">34552</id><kernel_version>2.6.32-431.3.1.el6.x86_64</kernel_version><lease_edate type="date" nil="true"></lease_edate><lease_sdate type="date" nil="true"></lease_sdate><name>npvm197.np.wc1.example.com</name><operating_system_id type="integer">230</operating_system_id><os_memory>64386</os_memory><os_processor_count type="integer">2</os_processor_count><os_virtual_processor_count type="integer">40</os_virtual_processor_count><physical_memory>65536</physical_memory><physical_memory_sizes>8x8192</physical_memory_sizes><power_supply_count type="integer" nil="true"></power_supply_count><preferred_operating_system_id type="integer" nil="true"></preferred_operating_system_id><processor_core_count type="integer">20</processor_core_count><processor_count type="integer">2</processor_count><processor_manufacturer>Intel</processor_manufacturer><processor_model>Xeon</processor_model><processor_socket_count type="integer">2</processor_socket_count><processor_speed>1700 MHz</processor_speed><rack_num nil="true"></rack_num><rack_row nil="true"></rack_row><rack_unit nil="true"></rack_unit><serial_number>MXQ41700MP      </serial_number><status_id type="integer">1</status_id><swap>2046</swap><timezone>UTC</timezone><uniqueid>31353337-3135-584D-5134-313730304D50</uniqueid><updated_at type="datetime">2016-06-14T20:46:44+00:00</updated_at><used_space type="integer">282143776</used_space><virtualarch>kvm</virtualarch><vmimg_size type="integer" nil="true"></vmimg_size><vmspace_used type="integer" nil="true"></vmspace_used></virtual_host></node></nodes>`},
			},
		},
		/*
			Set:
			nv --exactget node=prod198.wc1.example.com --addtonodegroup sudo_jorgetapia
			nv --name npvm109.np.wc1.example.com --addtonodegroup ss-host_np,kvm
			nv --name gearman --set contact=mk7193,edavis,jskaletsky,jg4843
			nv --name cephvm[0-9] --set status=ss-test
			nv --name cephvm[0-9] --set expiration=2015-09-05T21:54:00+00:00
		*/
	}

	tp := NewTestServer()
	driver.SetServer(tp.URL)

	initResponses()

	for _, tc := range tcs {

		for _, resp := range tc.resp {
			r := httptest.NewRecorder()
			r.Header().Set("Content-Type", "application/xml")
			r.WriteHeader(resp.code)
			r.Write([]byte(resp.response))
			responses[resp.key] = r
		}
		driver = NewNventoryDriver(bufio.NewReader(strings.NewReader(tc.input.userInput)))
		driver.SetServer(tp.URL)

		act, _ := SetByCommand(driver, tc.input.searchCommand)

		for _, e := range tc.exp {
			assert.Equal(t, strings.Contains(act, e), true, fmt.Sprintf("search %V\n(%#v expected,  %#v found)", tc.input.searchCommand, e, act))
		}
	}
}

type RSC struct {
	key      resp_key
	code     int
	response string
}

func initResponses() {
	responses = make(map[resp_key]*httptest.ResponseRecorder)

	// map[resp_key]*httptest.ResponseRecorder

	data := []RSC{
		{key: resp_key{m: "POST", p: "/accounts.xml"}, code: 201, response: "<account/>"},
		{key: resp_key{m: "GET", p: "/nodes/field_names.xml"}, code: 200, response: `<field_names><field_name>name</field_name><field_name>serial_number</field_name><field_name>created_at</field_name><field_name>updated_at</field_name><field_name>processor_manufacturer</field_name><field_name>processor_model</field_name><field_name>processor_speed</field_name><field_name>physical_memory</field_name><field_name>physical_memory_sizes</field_name><field_name>os_memory</field_name><field_name>swap</field_name><field_name>console_type</field_name><field_name>uniqueid</field_name><field_name>kernel_version</field_name><field_name>description</field_name><field_name>asset_tag</field_name><field_name>timezone</field_name><field_name>expiration</field_name><field_name>contact</field_name><field_name>virtualarch</field_name><field_name>vmimg_size</field_name><field_name>vmspace_used</field_name><field_name>used_space</field_name><field_name>avail_space</field_name><field_name>config_mgmt_tag</field_name><field_name>lease_sdate</field_name><field_name>lease_edate</field_name><field_name>cage</field_name><field_name>rack_row</field_name><field_name>rack_num</field_name><field_name>rack_unit</field_name><field_name>volumes_mounted[name] (volumes_mounted)</field_name><field_name>volumes_mounted[volume_type]</field_name><field_name>volumes_mounted[configf]</field_name><field_name>volumes_mounted[description]</field_name><field_name>volumes_mounted[created_at]</field_name><field_name>volumes_mounted[updated_at]</field_name><field_name>volumes_mounted[capacity]</field_name><field_name>volumes_mounted[size]</field_name><field_name>volumes_mounted[vendor]</field_name><field_name>volumes_mounted[businfo]</field_name><field_name>volumes_mounted[serial]</field_name><field_name>volumes_mounted[physid]</field_name><field_name>volumes_mounted[dev]</field_name><field_name>volumes_mounted[logicalname]</field_name><field_name>status[name] (status)</field_name><field_name>status[description]</field_name><field_name>status[created_at]</field_name><field_name>status[updated_at]</field_name><field_name>virtual_host[name] (virtual_host)</field_name><field_name>virtual_host[serial_number]</field_name><field_name>virtual_host[created_at]</field_name><field_name>virtual_host[updated_at]</field_name><field_name>virtual_host[processor_manufacturer]</field_name><field_name>virtual_host[processor_model]</field_name><field_name>virtual_host[processor_speed]</field_name><field_name>virtual_host[physical_memory]</field_name><field_name>virtual_host[physical_memory_sizes]</field_name><field_name>virtual_host[os_memory]</field_name><field_name>virtual_host[swap]</field_name><field_name>virtual_host[console_type]</field_name><field_name>virtual_host[uniqueid]</field_name><field_name>virtual_host[kernel_version]</field_name><field_name>virtual_host[description]</field_name><field_name>virtual_host[asset_tag]</field_name><field_name>virtual_host[timezone]</field_name><field_name>virtual_host[expiration]</field_name><field_name>virtual_host[contact]</field_name><field_name>virtual_host[virtualarch]</field_name><field_name>virtual_host[vmimg_size]</field_name><field_name>virtual_host[vmspace_used]</field_name><field_name>virtual_host[used_space]</field_name><field_name>virtual_host[avail_space]</field_name><field_name>virtual_host[config_mgmt_tag]</field_name><field_name>virtual_host[lease_sdate]</field_name><field_name>virtual_host[lease_edate]</field_name><field_name>virtual_host[cage]</field_name><field_name>virtual_host[rack_row]</field_name><field_name>virtual_host[rack_num]</field_name><field_name>virtual_host[rack_unit]</field_name><field_name>preferred_operating_system[name] (preferred_operating_system)</field_name><field_name>preferred_operating_system[vendor]</field_name><field_name>preferred_operating_system[variant]</field_name><field_name>preferred_operating_system[version_number]</field_name><field_name>preferred_operating_system[created_at]</field_name><field_name>preferred_operating_system[updated_at]</field_name><field_name>preferred_operating_system[architecture]</field_name><field_name>preferred_operating_system[description]</field_name><field_name>node_groups[name] (node_groups)</field_name><field_name>node_groups[description]</field_name><field_name>node_groups[created_at]</field_name><field_name>node_groups[updated_at]</field_name><field_name>node_groups[owner]</field_name><field_name>virtual_guests[name] (virtual_guests)</field_name><field_name>virtual_guests[serial_number]</field_name><field_name>virtual_guests[created_at]</field_name><field_name>virtual_guests[updated_at]</field_name><field_name>virtual_guests[processor_manufacturer]</field_name><field_name>virtual_guests[processor_model]</field_name><field_name>virtual_guests[processor_speed]</field_name><field_name>virtual_guests[physical_memory]</field_name><field_name>virtual_guests[physical_memory_sizes]</field_name><field_name>virtual_guests[os_memory]</field_name><field_name>virtual_guests[swap]</field_name><field_name>virtual_guests[console_type]</field_name><field_name>virtual_guests[uniqueid]</field_name><field_name>virtual_guests[kernel_version]</field_name><field_name>virtual_guests[description]</field_name><field_name>virtual_guests[asset_tag]</field_name><field_name>virtual_guests[timezone]</field_name><field_name>virtual_guests[expiration]</field_name><field_name>virtual_guests[contact]</field_name><field_name>virtual_guests[virtualarch]</field_name><field_name>virtual_guests[vmimg_size]</field_name><field_name>virtual_guests[vmspace_used]</field_name><field_name>virtual_guests[used_space]</field_name><field_name>virtual_guests[avail_space]</field_name><field_name>virtual_guests[config_mgmt_tag]</field_name><field_name>virtual_guests[lease_sdate]</field_name><field_name>virtual_guests[lease_edate]</field_name><field_name>virtual_guests[cage]</field_name><field_name>virtual_guests[rack_row]</field_name><field_name>virtual_guests[rack_num]</field_name><field_name>virtual_guests[rack_unit]</field_name><field_name>ip_addresses[address] (ip_addresses)</field_name><field_name>ip_addresses[address_type]</field_name><field_name>ip_addresses[netmask]</field_name><field_name>ip_addresses[broadcast]</field_name><field_name>ip_addresses[created_at]</field_name><field_name>ip_addresses[updated_at]</field_name><field_name>ip_addresses[nmap_last_scanned_at]</field_name><field_name>comments[title]</field_name><field_name>comments[comment] (comments)</field_name><field_name>comments[created_at]</field_name><field_name>comments[commentable_type]</field_name><field_name>database_instances[name] (database_instances)</field_name><field_name>database_instances[description]</field_name><field_name>database_instances[created_at]</field_name><field_name>database_instances[updated_at]</field_name><field_name>services[name] (services)</field_name><field_name>services[description]</field_name><field_name>services[created_at]</field_name><field_name>services[updated_at]</field_name><field_name>services[owner]</field_name><field_name>node_rack[name] (node_rack)</field_name><field_name>node_rack[location]</field_name><field_name>node_rack[description]</field_name><field_name>node_rack[created_at]</field_name><field_name>node_rack[updated_at]</field_name><field_name>produced_outlets[name] (produced_outlets)</field_name><field_name>produced_outlets[created_at]</field_name><field_name>produced_outlets[updated_at]</field_name><field_name>produced_outlets[consumer_type]</field_name><field_name>lb_pools[name] (lb_pools)</field_name><field_name>lb_pools[description]</field_name><field_name>lb_pools[created_at]</field_name><field_name>lb_pools[updated_at]</field_name><field_name>lb_pools[owner]</field_name><field_name>network_interfaces[name] (network_interfaces)</field_name><field_name>network_interfaces[interface_type]</field_name><field_name>network_interfaces[physical]</field_name><field_name>network_interfaces[hardware_address]</field_name><field_name>network_interfaces[up]</field_name><field_name>network_interfaces[link]</field_name><field_name>network_interfaces[speed]</field_name><field_name>network_interfaces[full_duplex]</field_name><field_name>network_interfaces[autonegotiate]</field_name><field_name>network_interfaces[created_at]</field_name><field_name>network_interfaces[updated_at]</field_name><field_name>name_aliases[name] (name_aliases)</field_name><field_name>name_aliases[source_type]</field_name><field_name>name_aliases[created_at]</field_name><field_name>name_aliases[updated_at]</field_name><field_name>accepted_roles[name]</field_name><field_name>accepted_roles[authorizable_type]</field_name><field_name>accepted_roles[created_at]</field_name><field_name>accepted_roles[updated_at]</field_name><field_name>consumed_outlets[name] (consumed_outlets)</field_name><field_name>consumed_outlets[created_at]</field_name><field_name>consumed_outlets[updated_at]</field_name><field_name>consumed_outlets[consumer_type]</field_name><field_name>drives[name] (drives)</field_name><field_name>drives[logicalname]</field_name><field_name>drives[vendor]</field_name><field_name>drives[physid]</field_name><field_name>drives[businfo]</field_name><field_name>drives[handle]</field_name><field_name>drives[serial]</field_name><field_name>drives[description]</field_name><field_name>drives[product]</field_name><field_name>drives[size]</field_name><field_name>drives[dev]</field_name><field_name>drives[created_at]</field_name><field_name>drives[updated_at]</field_name><field_name>storage_controllers[name] (storage_controllers)</field_name><field_name>storage_controllers[controller_type]</field_name><field_name>storage_controllers[physical]</field_name><field_name>storage_controllers[businfo]</field_name><field_name>storage_controllers[slot]</field_name><field_name>storage_controllers[firmware]</field_name><field_name>storage_controllers[cache_size]</field_name><field_name>storage_controllers[batteries]</field_name><field_name>storage_controllers[created_at]</field_name><field_name>storage_controllers[updated_at]</field_name><field_name>storage_controllers[product]</field_name><field_name>storage_controllers[description]</field_name><field_name>storage_controllers[physid]</field_name><field_name>storage_controllers[vendor]</field_name><field_name>storage_controllers[handle]</field_name><field_name>storage_controllers[logicalname]</field_name><field_name>hosted_vips[name] (hosted_vips)</field_name><field_name>hosted_vips[description]</field_name><field_name>hosted_vips[created_at]</field_name><field_name>hosted_vips[updated_at]</field_name><field_name>hosted_vips[ip_address]</field_name><field_name>hosted_vips[protocol]</field_name><field_name>hosted_vips[port]</field_name><field_name>hardware_profile[name] (hardware_profile)</field_name><field_name>hardware_profile[manufacturer]</field_name><field_name>hardware_profile[rack_size]</field_name><field_name>hardware_profile[memory]</field_name><field_name>hardware_profile[disk]</field_name><field_name>hardware_profile[nics]</field_name><field_name>hardware_profile[processor_model]</field_name><field_name>hardware_profile[processor_speed]</field_name><field_name>hardware_profile[cards]</field_name><field_name>hardware_profile[description]</field_name><field_name>hardware_profile[estimated_cost]</field_name><field_name>hardware_profile[created_at]</field_name><field_name>hardware_profile[updated_at]</field_name><field_name>hardware_profile[visualization_color]</field_name><field_name>hardware_profile[outlet_type]</field_name><field_name>hardware_profile[model]</field_name><field_name>hardware_profile[processor_manufacturer]</field_name><field_name>hardware_profile[power_consumption]</field_name><field_name>operating_system[name] (operating_system)</field_name><field_name>operating_system[vendor]</field_name><field_name>operating_system[variant]</field_name><field_name>operating_system[version_number]</field_name><field_name>operating_system[created_at]</field_name><field_name>operating_system[updated_at]</field_name><field_name>operating_system[architecture]</field_name><field_name>operating_system[description]</field_name><field_name>virtual_assignments_as_host[assigned_at] (virtual_assignments_as_host)</field_name><field_name>virtual_assignments_as_host[created_at]</field_name><field_name>virtual_assignments_as_host[updated_at]</field_name><field_name>volumes_served[name] (volumes_served)</field_name><field_name>volumes_served[volume_type]</field_name><field_name>volumes_served[configf]</field_name><field_name>volumes_served[description]</field_name><field_name>volumes_served[created_at]</field_name><field_name>volumes_served[updated_at]</field_name><field_name>volumes_served[capacity]</field_name><field_name>volumes_served[size]</field_name><field_name>volumes_served[vendor]</field_name><field_name>volumes_served[businfo]</field_name><field_name>volumes_served[serial]</field_name><field_name>volumes_served[physid]</field_name><field_name>volumes_served[dev]</field_name><field_name>volumes_served[logicalname]</field_name><field_name>virtual_assignment_as_guest[assigned_at] (virtual_assignment_as_guest)</field_name><field_name>virtual_assignment_as_guest[created_at]</field_name><field_name>virtual_assignment_as_guest[updated_at]</field_name></field_names>`},
		{key: resp_key{m: "POST", p: "/accounts.xml"}, code: 200, response: `<?xml version="1.0" encoding="UTF-8"?>`},
	}
	for _, d := range data {
		r := httptest.NewRecorder()
		r.Header().Set("Content-Type", "application/xml")
		r.WriteHeader(d.code)
		r.Write([]byte(d.response))

		responses[d.key] = r
	}
}

func NewTestServer() *httptest.Server {
	requests = requests[:]
	ts := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		requests = append(requests, r)

		if resp, ok := responses[resp_key{r.Method, r.URL.Path}]; ok {
			for k, v := range resp.Header() {
				w.Header()[k] = v
			}
			w.WriteHeader(resp.Code)
			w.Write(resp.Body.Bytes())
		} else {
			println(fmt.Sprintf("no response found for %v", resp_key{r.Method, r.URL.Path}))
			http.Error(w, "no valid responses", 1000)
		}
	}))

	return ts
}
